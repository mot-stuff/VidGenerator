{% extends "base.html" %}
{% from "_components.html" import collapsible %}

{% block title %}Dashboard - TTS Shorts Generator{% endblock %}

{% block content %}
<div class="container">
    {% call collapsible('Profile', open=True) %}
    <div class="content">
        <div class="section">
            <h2>Account</h2>
            <div class="wizard-summary">
                <div class="wizard-summary-row"><div>Email</div><div>{{ user.email }}</div></div>
                <div class="wizard-summary-row"><div>Remaining today</div><div id="quotaSummaryText">{{ user.remaining_daily_quota() }} / {{ user.get_daily_quota() }}{% if user.bonus_credits and user.bonus_credits > 0 %} (+{{ user.bonus_credits }} bonus){% endif %}</div></div>
                <div class="wizard-summary-row"><div>Plan</div><div>{{ user.subscription_tier }}</div></div>
            </div>
            <div id="rewardedConfig" data-ad-unit-path="{{ config.get('GAM_REWARDED_AD_UNIT_PATH', '') }}" class="hidden"></div>
            <div id="rewardedContainer" class="hidden" style="margin-top: 12px;">
                <button class="btn btn-secondary" type="button" id="watchAdBtn">Watch an ad to get +1 generation</button>
                <div class="wizard-hint" style="margin-top: 8px;">
                    If you're out of quota, you can opt in to a rewarded video ad to unlock one extra generation.
                </div>
            </div>
            <div class="wizard-hint">
                Quota resets daily (UTC).
            </div>
        </div>
    </div>
    {% endcall %}

    {% call collapsible('Brain Blender', open=False) %}
    <div class="content">
        <div class="section">
            <h2>About</h2>
            <div class="wizard-hint">
                Brain Blender turns text into short-form videos with TTS + your background footage.
                Upload a video, paste or batch-upload text, generate, then download from the queue.
            </div>
            <div class="wizard-hint">
                Downloads auto-expire, so grab completed jobs quickly.
            </div>
        </div>

        <div class="wizard-stepper" id="wizardStepper">
            <button class="wizard-step" type="button" data-step="1">1. Text</button>
            <button class="wizard-step" type="button" data-step="2">2. Video</button>
            <button class="wizard-step" type="button" data-step="3">3. Generate</button>
        </div>

        <div class="wizard-panel" id="step1Panel">
            <div class="section">
                <h2>Step 1: Text</h2>

                <div class="wizard-row">
                    <label class="wizard-radio">
                        <input type="radio" name="textMode" value="single" checked>
                        Single
                    </label>
                    <label class="wizard-radio">
                        <input type="radio" name="textMode" value="batch">
                        Batch
                    </label>
                </div>

                <div id="singleTextSection">
                    <div class="form-group">
                        <label for="textInput">Enter text</label>
                        <textarea id="textInput" placeholder="Type your text here..."></textarea>
                    </div>
                    <button class="btn btn-secondary" type="button" id="addToBatchBtn">Add to list</button>
                </div>

                <div id="batchSection" class="hidden">
                    <div class="form-group">
                        <label for="csvFile">Upload CSV/TXT (one per line or first column)</label>
                        <input type="file" id="csvFile" accept=".csv,.txt">
                        <div id="csvInfo" class="file-info hidden"></div>
                    </div>
                </div>

                <div class="wizard-list">
                    <div class="wizard-list-header">
                        <div>Items</div>
                        <div class="wizard-list-meta"><span id="textCount">0</span></div>
                    </div>
                    <div id="textList" class="wizard-list-body"></div>
                    <div class="wizard-list-actions">
                        <button class="btn btn-secondary" type="button" id="clearTextsBtn">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="wizard-panel hidden" id="step2Panel">
            <div class="section">
                <h2>Step 2: Background video(s)</h2>

                <div class="checkbox-group">
                    <input type="checkbox" id="splitScreen">
                    <label for="splitScreen">Split screen (2 videos)</label>
                </div>

                <div class="video-section">
                    <div class="video-upload">
                        <label for="video1">Video 1 <span id="video1Label"></span></label>
                        <input type="file" id="video1" accept="video/*">
                        <div id="video1Info" class="file-info hidden"></div>
                    </div>
                    <div class="video-upload video2-section" id="video2Section">
                        <label for="video2">Video 2</label>
                        <input type="file" id="video2" accept="video/*">
                        <div id="video2Info" class="file-info hidden"></div>
                    </div>
                </div>

                <div class="wizard-hint">
                    Uploads store the full file, but the generator only processes a short random subclip equal to your TTS length.
                </div>
            </div>
        </div>

        <div class="wizard-panel hidden" id="step3Panel">
            <div class="section">
                <h2>Step 3: Generate</h2>

                <div class="wizard-summary" id="wizardSummary"></div>

                <div class="wizard-actions">
                    <button class="btn" type="button" id="generateBtn">Generate</button>
                </div>

                <div class="wizard-hint">
                    Downloads expire quickly (auto-delete). Download as soon as a job is completed.
                </div>
            </div>

            <div class="section">
                <h2>Queue</h2>
                <div class="file-list" id="fileList">
                    <div style="padding: 20px; text-align: center; color: #6b7280;">Loading recent jobs...</div>
                </div>
                <button class="btn btn-secondary" type="button" id="refreshJobsBtn">Refresh</button>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <div class="status-dot"></div>
            <span id="statusText">Ready to generate videos</span>
        </div>
        <div class="controls">
            <button class="btn btn-secondary" type="button" id="backBtn">Back</button>
            <button class="btn" type="button" id="nextBtn">Next</button>
        </div>
    </div>
    {% endcall %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/rewarded_ads.js') }}"></script>
{% endblock %}
